// ignore_for_file: avoid_print

import 'package:flutter_test/flutter_test.dart';
import 'package:textify/bands.dart';
import 'package:textify/models/int_offset.dart';

void main() {
  group('mergeBandsHorizontally', () {
    test('handles single band', () {
      final band = Band();
      final bands = Bands([band]);
      bands.mergeBandsHorizontally();
      expect(bands.length, 1);
      expect(band.toString(), '[0] Avg(W:0, H:0 G:-1)');

      //
      // Add an empty artifact (aka Space)
      //
      band.artifacts.add(Artifact(8, 16));
      band.artifacts.last.matchingCharacter = ' ';
      expect(band.toString(), '[1] Avg(W:8, H:16 G:-1) S[1]');
    });

    test('merges multiple empty bands in sequence', () {
      final band1 = Band();
      final band2 = Band();
      final band3 = Band();
      final bands = Bands([band1, band2, band3]);
      bands.mergeBandsHorizontally();

      // Nothing sould have change since there's no data in the bands to take action on
      expect(bands.length, 3);

      // now test that we can clean up
      bands.removeEmptyBands();
      expect(bands.length, 0);
    });

    test('merges adjacent bands with vertical alignment', () {
      // BAND 1 LEFT
      final Band band1 = Band();
      final Artifact artifact1 = Artifact(20, 20);
      artifact1.setBothLocation(const IntOffset(10, 10));
      artifact1.setGridFromBools([
        [true, false, true],
        [true, false, true],
      ]);
      band1.addArtifact(artifact1);

      // BAND 2 RIGHT
      final Band band2 = Band();
      final Artifact artifact2 = Artifact(20, 20);
      artifact2.setBothLocation(const IntOffset(14, 10));
      artifact2.setGridFromBools([
        [true, false, true],
        [true, false, true],
      ]);
      band2.addArtifact(artifact2);

      // ALL BANDS
      final Bands bands = Bands([band1, band2]);
      bands.mergeBandsHorizontally();

      expect(bands.length, 1);
      expect(bands.list.first.artifacts.length, 2);
      expect(band1.toString(), '[2] Avg(W:2, H:2 G:1)');
      expect(band2.toString(), '[1] Avg(W:3, H:2 G:-1)');
    });

    test('does not merge bands with large horizontal gap', () {
      final Band band1 = Band();
      final Artifact artifact1 = Artifact(20, 20);
      artifact1.setBothLocation(const IntOffset(10, 10));
      band1.addArtifact(artifact1);

      final Band band2 = Band();
      final Artifact artifact2 = Artifact(20, 20);
      artifact2.setBothLocation(const IntOffset(500, 10));
      band2.addArtifact(artifact2);

      final Bands bands = Bands([band1, band2]);
      bands.mergeBandsHorizontally();

      expect(bands.length, 2);
    });
  });

  group('sorting of band', () {
    test('sorts bands by vertical position first', () {
      final band1 = Band();
      final artifact1 = Artifact(20, 20);
      artifact1.setBothLocation(const IntOffset(10, 20));
      band1.addArtifact(artifact1);

      final band2 = Band();
      final artifact2 = Artifact(20, 20);
      artifact2.setBothLocation(const IntOffset(5, 10));
      band2.addArtifact(artifact2);

      final bands = Bands([band1, band2]);
      bands.sortTopLeftToBottomRight();

      expect(bands.list[0], band2);
      expect(bands.list[1], band1);
    });

    test('sorts bands horizontally when at same vertical position', () {
      final band1 = Band();
      final artifact1 = Artifact(20, 20);
      artifact1.setBothLocation(const IntOffset(20, 10));
      band1.addArtifact(artifact1);

      final band2 = Band();
      final artifact2 = Artifact(20, 20);
      artifact2.setBothLocation(const IntOffset(10, 10));
      band2.addArtifact(artifact2);

      final bands = Bands([band1, band2]);
      bands.sortTopLeftToBottomRight();

      expect(bands.list[0], band2);
      expect(bands.list[1], band1);
    });

    group('sortVerticallyThenHorizontally', () {
      test('sorts bands horizontally when on same vertical line', () {
        // Create bands with same vertical position but different horizontal positions
        final band1 = Band();
        final artifact1 = Artifact(10, 10);
        artifact1.setBothLocation(const IntOffset(30, 20)); // x=30
        band1.addArtifact(artifact1);

        final band2 = Band();
        final artifact2 = Artifact(10, 10);
        artifact2.setBothLocation(
          const IntOffset(10, 20),
        ); // x=10, same y as band1
        band2.addArtifact(artifact2);

        final bands = [band1, band2];

        // Sort the bands
        Bands.sortVerticallyThenHorizontally(bands, threshold: 5.0);

        // Verify bands are sorted by x-coordinate when y is within threshold
        expect(bands[0], band2); // band2 should come first (x=10)
        expect(bands[1], band1); // band1 should come second (x=30)
      });
    });

    test('maintains order for bands at exact same position', () {
      final band1 = Band();
      final artifact1 = Artifact(20, 20);
      artifact1.setBothLocation(const IntOffset(10, 10));
      band1.addArtifact(artifact1);

      final band2 = Band();
      final artifact2 = Artifact(20, 20);
      artifact2.setBothLocation(const IntOffset(10, 10));
      band2.addArtifact(artifact2);

      final bands = Bands([band1, band2]);
      bands.sortTopLeftToBottomRight();

      expect(bands.list[0], band1);
      expect(bands.list[1], band2);
    });

    test('handles empty bands list', () {
      final bands = Bands([]);
      bands.sortTopLeftToBottomRight();
      expect(bands.length, 0);
    });
  });

  group('splitChunk', () {
    test('splits artifact with clear column separation', () {
      final Band band = Band();

      // Create an artifact representing two characters with a gap between them
      final Artifact artifact = Artifact.fromAsciiDefinition([
        '##..##',
        '##..##',
        '##..##',
        '######',
      ]);
      expect(artifact.cols, 6);
      band.addArtifact(artifact);

      // Call the method being tested
      final List<Artifact> result = band.splitChunk(artifact);

      // Verify the artifact was split correctly
      expect(result.length, 2);
      expect(result[0].gridToStrings(), ['##.', '##.', '##.', '###']);

      expect(result[1].gridToStrings(), ['.##', '.##', '.##', '###']);
    });

    test('getWideChunks handles two artifacts with similar widths', () {
      final Band band = Band();

      // Create two artifacts with similar widths
      final Artifact artifact1 = Artifact(10, 5);
      artifact1.setBothLocation(const IntOffset(0, 0));

      final Artifact artifact2 = Artifact(10, 5);
      artifact2.setBothLocation(const IntOffset(20, 0));

      band.addArtifact(artifact1);
      band.addArtifact(artifact2);

      // Test the special case for 2 artifacts with similar widths
      final List<Artifact> wideChunks = band.getWideChunks();

      // Should return empty list since width ratio is between 0.7 and 1.3
      expect(wideChunks.isEmpty, true);

      // Now test with dissimilar widths
      band.artifacts.clear();
      final Artifact artifact3 = Artifact(10, 5);
      artifact3.setBothLocation(const IntOffset(0, 0));

      final Artifact artifact4 = Artifact(50, 5); // Much wider
      artifact4.setBothLocation(const IntOffset(15, 0));

      band.addArtifact(artifact3);
      band.addArtifact(artifact4);

      final List<Artifact> wideChunks2 = band.getWideChunks();

      // Should identify the wider artifact
      expect(wideChunks2.length, 1);
      expect(wideChunks2[0], artifact4);
    });

    test('returns empty list when artifact cannot be split', () {
      final Band band = Band();

      // Create an artifact with no clear separation
      final Artifact artifact = Artifact.fromAsciiDefinition([
        '####',
        '####',
        '####',
      ]);

      band.addArtifact(artifact);

      // Call the method being tested
      final List<Artifact> result = band.splitChunk(artifact);

      // Verify no split occurred
      expect(result, isEmpty);
    });

    test('splits artifact with multiple column separations', () {
      final Band band = Band();

      // Create an artifact representing three characters with gaps between them
      final Artifact artifact = Artifact.fromAsciiWithNewlines(
        '''..........##################################.......................................................................#################################...........................................######################################..........................................................###############################################################........................................
.........####################################....................................................................#####################################........................................#########################################......................................................######################################################################...................................
.........####################################....................................................................#####################################........................................#########################################......................................................#########################################################################................................
.........#####################################..................................................................######################################.......................................##########################################......................................................##############################################################################...........................
.........#####################################..................................................................######################################.......................................###########################################.....................................................##################################################################################.......................
.........######################################.................................................................######################################.......................................###########################################.....................................................###################################################################################......................
.........######################################.................................................................######################################.......................................###########################################.....................................................####################################################################################.....................
.........#######################################................................................................######################################.......................................###########################################.....................................................######################################################################################...................
.........#######################################................................................................######################################.......................................############################################....................................................#######################################################################################..................
..........######################################...............................................................####################################............................................##########################################.........................................................##################################################################################..................
....................############################...............................................................###########################................................................................################################................................................................###########################################################################.................
.....................###########################..............................................................###########################..................................................................################################................................................................###########################################################################................
......................###########################............................................................############################..................................................................################################.................................................................###########################################################################...............
......................###########################............................................................############################..................................................................################################.................................................................#################..................................########################...............
......................###########################............................................................############################..................................................................###############...###############................................................................################.......................................#####################..............
.......................###########################...........................................................############################..................................................................##############.....##############................................................................################.........................................###################..............
.......................############################.........................................................#############################..................................................................##############.....##############................................................................################..........................................###################.............
.......................############################.........................................................#############################..................................................................##############.....##############................................................................################...........................................###################............
......................#############################.........................................................#############################.................................................................##############.......##############...............................................................################............................................##################............
......................##############################........................................................#############################................................................................##############........###############..............................................................################.............................................##################...........
......................##############################.......................................................##############################................................................................#############..........##############..............................................................################..............................................#################...........
......................##############################.......................................................##############################...............................................................##############..........###############.............................................................################..............................................#################...........
......................##############################......................................................##############.################...............................................................##############...........##############.............................................................################...............................................################...........
......................#############..###############......................................................#############...###############...............................................................##############...........##############.............................................................################...............................................################...........
......................#############...###############....................................................##############...###############...............................................................#############.............#############.............................................................################................................................###############...........
......................#############...###############....................................................#############....###############..............................................................##############.............##############............................................................################................................................###############...........
.....................#############.....###############...................................................#############.....##############..............................................................##############.............##############............................................................################................................................###############...........
.....................#############......###############..................................................#############.....##############.............................................................##############..............###############...........................................................################................................................###############...........
.....................#############.......##############.................................................##############.....##############............................................................##############................###############...........................................................###############.................................................##############...........
.....................#############.......##############.................................................#############......##############............................................................##############................###############...........................................................###############.................................................##############...........
.....................#############........##############................................................############.......##############............................................................#############..................###############..........................................................###############.................................................###############..........
.....................#############........##############...............................................#############.......##############...........................................................##############...................##############..........................................................###############.................................................###############..........
.....................#############........##############..............................................#############........##############...........................................................##############...................##############..........................................................###############.................................................###############..........
.....................#############........##############..............................................#############........##############...........................................................##############...................##############..........................................................###############.................................................###############..........
.....................#############........##############.............................................##############........##############...........................................................#############....................###############.........................................................###############.................................................###############..........
.....................#############.........##############............................................#############.........##############..........................................................##############.....................##############.........................................................###############.................................................##############...........
.....................#############.........##############............................................#############.........##############.........................................................##############......................###############........................................................###############.................................................##############...........
....................##############.........###############...........................................#############.........###############.......................................................###############......................################.......................................................###############.................................................##############...........
....................##############..........###############..........................................#############.........###############.......................................................##############........................###############.......................................................###############................................................###############...........
....................##############...........##############.........................................#############..........###############.......................................................##############.........................##############.......................................................###############................................................###############...........
....................##############...........##############.........................................#############..........###############.......................................................#############..........................##############.......................................................###############................................................###############...........
....................##############............#############.........................................############...........###############......................................................##############...........................##############......................................................###############...............................................################...........
....................##############............#############........................................############.............##############......................................................##############...........................##############......................................................###############..............................................#################...........
....................##############............##############......................................#############.............###############....................................................###############...........................##############......................................................###############..............................................#################...........
....................##############............##############......................................#############.............###############....................................................##############............................###############.....................................................###############..............................................#################...........
....................#############.............##############......................................#############.............###############...................................................###############.............................###############....................................................###############.............................................#################............
....................#############..............##############....................................##############.............###############...................................................##############..............................###############....................................................###############.............................................#################............
....................#############..............###############...................................#############..............###############..................................................##############................................###############...................................................###############...........................................##################.............
....................#############...............##############...................................#############..............###############..................................................##############.................................##############...................................................###############.........................................####################.............
....................#############................#############...................................#############..............###############..................................................##############.................................##############...................................................###############........................................####################..............
....................#############................##############.................................#############...............###############.................................................##############..................................###############..................................................###############.......................................####################...............
....................#############................##############.................................############.................##############.................................................##############...................................##############..................................................################...............................###########################...............
....................#############................##############................................#############.................###############...............................................###############...................................##############..................................................##########################################################################...............
....................#############.................#############...............................#############..................###############..............................................################...................................###############.................................................#########################################################################................
....................#############.................#############...............................#############..................###############..............................................###############....................................################................................................#######################################################################..................
....................#############.................##############..............................#############..................###############..............................................##############......................................###############................................................#######################################################################..................
....................#############.................##############..............................#############..................###############.............................................###############......................................################...............................................######################################################################...................
....................#############..................##############............................##############..................###############.............................................##############........................................###############...............................................####################################################################.....................
....................#############...................##############...........................#############....................##############.............................................##############.........................................##############...............................................##################################################################.......................
....................#############...................##############...........................#############....................##############.............................................##############.........................................##############...............................................#################################################################........................
....................############.....................#############...........................############.....................##############............................................###############.........................................###############..............................................###############################################################..........................
...................#############.....................#############..........................#############.....................##############...........................................################.........................................###############..............................................##########################################################...............................
...................#############.....................##############........................#############......................##############..........................................#################.........................................################.............................................########################################################.................................
...................#############.....................##############........................#############......................##############..........................................#################.........................................#################............................................#######################################################..................................
...................#############.....................##############.......................##############......................##############..........................................#################.........................................#################............................................#######################################################..................................
...................#############......................#############.......................#############.......................##############..........................................##################.......................................##################............................................################...................####################..................................
...................############.......................##############......................#############.......................##############.........................................#############################################################################...........................................###############......................###################.................................
...................############.......................###############.....................#############.......................##############.........................................#############################################################################...........................................###############.......................##################.................................
...................############........................##############.....................#############.......................##############.........................................#############################################################################...........................................###############........................#################.................................
...................############.........................##############...................#############........................##############........................................###############################################################################..........................................###############.........................#################................................
..................#############.........................##############...................############.........................##############.......................................################################################################################..........................................###############..........................#################...............................
..................#############..........................#############..................#############.........................##############.......................................#################################################################################.........................................###############...........................#################..............................
..................#############..........................#############..................############..........................##############......................................###################################################################################........................................###############...........................#################..............................
..................#############..........................#############.................#############..........................##############......................................###################################################################################........................................###############............................#################.............................
..................#############..........................##############................#############..........................##############......................................###################################################################################........................................###############............................#################.............................
..................#############..........................##############................#############...........................##############.....................................###################################################################################........................................###############.............................#################............................
.................#############............................#############...............#############............................##############....................................#####################################################################################.......................................###############..............................#################...........................
.................#############............................##############..............#############............................##############...................................#################.....................................................################.......................................###############...............................#################..........................
.................#############.............................##############.............#############............................##############..................................#################.......................................................###############.......................................###############...............................#################..........................
.................#############.............................##############.............#############............................##############..................................################........................................................################......................................###############...............................#################..........................
.................#############..............................#############............#############.............................##############..................................################.........................................................################.....................................###############................................#################.........................
.................#############..............................##############...........############..............................##############.................................################..........................................................################.....................................###############................................##################........................
.................#############..............................##############..........#############..............................##############.................................###############............................................................################....................................###############.................................##################.......................
.................#############...............................#############.........#############...............................##############.................................##############..............................................................###############....................................###############..................................#################.......................
.................#############...............................#############.........#############...............................##############.................................##############..............................................................###############....................................###############..................................##################......................
.................#############...............................#############.........#############...............................##############................................###############...............................................................##############....................................###############...................................#################......................
.................#############...............................##############........#############...............................##############...............................################...............................................................###############...................................###############...................................#################......................
.................#############................................#############........#############...............................###############..............................###############................................................................################..................................###############....................................#################.....................
.................#############.................................#############......#############................................###############.............................################.................................................................################.................................###############.....................................#################....................
.................#############.................................##############.....#############................................###############.............................################.................................................................################.................................###############.....................................##################...................
.................#############..................................##############....############.................................###############.............................###############..................................................................################................................################......................................#################...................
................##############..................................###############..############..................................###############............................###############....................................................................################...............................################......................................#################...................
................##############..................................#############################..................................################...........................###############....................................................................################...............................################.......................................#################..................
................##############..................................#############################..................................################..........................################.....................................................................###############...............................################.......................................#################..................
................##############..................................#############################..................................################..........................###############.......................................................................###############..............................################........................................#################.................
................##############...................................###########################...................................################.........................################.......................................................................###############..............................################.........................................#################................
................##############...................................###########################...................................################........................#################.......................................................................################.............................################.........................................##################...............
................##############...................................###########################...................................################........................#################.......................................................................#################............................################..........................................#################...............
................##############....................................##########################...................................################........................#################.......................................................................#################............................################..........................................##################..............
................##############.....................................########################....................................#################.......................################........................................................................#################............................################..........................................##################..............
...............###############.....................................#######################.....................................#################......................#################........................................................................##################..........................##################..........................................##################.............
...............################....................................#######################....................................##################.....................###################.......................................................................##################..........................##################..........................................####################...........
............####################....................................#####################....................................#####################................########################...................................................................######################......................######################.........................................#####################.........
.############################################.......................#####################.......................###################################################################################...............................................############################################################################################...........................#############################
#############################################.......................#####################.......................###################################################################################..............................................#############################################################################################...........................#############################
#############################################.......................#####################.......................###################################################################################..............................................#############################################################################################............................############################
#############################################........................###################........................###################################################################################..............................................#############################################################################################............................############################
#############################################........................###################........................###################################################################################..............................................#############################################################################################............................############################
#############################################.........................##################........................###################################################################################..............................................#############################################################################################.............................###########################
#############################################.........................#################.........................###################################################################################..............................................#############################################################################################..............................##########################
#############################################..........................################.........................###################################################################################..............................................#############################################################################################..............................##########################
#############################################..........................###############..........................###################################################################################..............................................#############################################################################################...............................#########################''',
      );

      band.addArtifact(artifact);

      final List<Artifact> result = band.splitChunk(artifact);

      // Verify the artifact was split correctly
      expect(result[0].cols, 157, reason: '${result[0].toText()}\n');
      expect(result[1].cols, 122, reason: '${result[1].toText()}\n');
      expect(result[2].cols, 111, reason: '${result[2].toText()}\n');
    });
  });
}
